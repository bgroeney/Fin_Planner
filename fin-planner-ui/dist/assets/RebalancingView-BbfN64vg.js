import{_ as re,w as de,x as ce,o as n,c as o,a as e,F as w,b as ve,n as r,t as l,p as A,v as Y,f as h,l as P,C as G,i as me,G as pe,z as g,s as F,g as d,h as he,B as q,e as ge,q as be}from"./index-oVbs5Hxd.js";import{usePortfolioStore as fe}from"./portfolio-CjZnfIUI.js";const ye={class:"rebalancing-view animate-fade-in content-container"},xe={key:0,class:"loader-container"},_e={class:"cash-flow-panel card mb-xl"},we={class:"mode-selector"},ke={key:0,class:"cash-flow-input-row"},Ce={class:"input-label"},Se={class:"currency-input"},Pe={class:"health-summary card mb-xl"},Fe={class:"health-item"},Me={class:"value"},De={key:0,class:"health-divider"},Le={key:1,class:"health-item"},Ve={class:"label"},Ae={class:"health-item"},$e={class:"label"},Ne={class:"value value-highlight"},Te={class:"health-item"},Ee={class:"health-item"},Be={class:"card mb-xl overflow-hidden"},Re={class:"data-table"},Ie={class:"cat-name"},Ue={class:"cat-value"},je={class:"text-right"},We={class:"percentage-bar-mini"},ze={class:"text-right"},He={class:"text-right"},Ye={class:"recommendations-section"},Ge={key:0,class:"empty-state card"},qe={key:1},Oe={class:"actions-list"},Je={class:"action-checkbox"},Ke=["onUpdate:modelValue"],Qe={class:"action-details"},Xe={class:"asset-info"},Ze={class:"symbol"},et={class:"name"},tt={class:"action-math"},st={class:"units"},at={class:"price"},lt={class:"action-total"},nt={class:"execution-mode-section card mt-xl"},ot={class:"exec-mode-selector"},it={key:0,class:"schedule-config"},ut={key:0,class:"config-row"},rt={class:"slider-group"},dt={class:"slider-value"},ct={class:"split-preview"},vt={class:"split-now"},mt={class:"split-later"},pt={class:"config-row-inline"},ht={class:"config-field"},gt=["value"],bt={class:"config-field"},ft={class:"timeline-preview"},yt={class:"timeline"},xt={class:"timeline-content"},_t={class:"timeline-date"},wt={class:"timeline-amount"},kt={key:0,class:"timeline-badge"},Ct={key:1,class:"timeline-badge period-badge"},St={class:"execution-footer mt-xl"},Pt={key:0,class:"exec-summary"},Ft={class:"exec-total-value"},Mt=["disabled"],Dt={key:0,class:"schedules-section mt-xl"},Lt={class:"schedule-header"},Vt={class:"schedule-mode-badge"},At={class:"schedule-meta"},$t={class:"schedule-progress"},Nt={class:"progress-bar"},Tt={class:"schedule-items"},Et={class:"item-period"},Bt={class:"item-date"},Rt={class:"item-amount"},It={class:"schedule-actions"},Ut=["onClick","disabled"],jt=["onClick"],Wt={key:2,class:"empty-state card"},zt={key:0,class:"modal-overlay"},Ht={class:"modal-card success-modal"},Yt={__name:"RebalancingView",setup(Gt){const O=he(),J=fe(),b=d(null),M=d(!0),$=d(!1),B=d(!1),R=d("Trades Executed!"),I=d("Your portfolio has been updated with the rebalancing transactions."),D=d([]),U=d([]),N=d(null),f=d("none"),_=d(0),u=d("LumpSum"),y=d(4),k=d("Monthly"),v=d(50),x=g(()=>J.currentPortfolioId),c=a=>new Intl.NumberFormat("en-AU",{style:"currency",currency:"AUD"}).format(a||0),j=a=>new Date(a).toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"}),m=g(()=>f.value==="none"||!_.value?0:f.value==="add"?_.value:-_.value),T=g(()=>b.value?b.value.categories.reduce((a,t)=>a+Math.abs(t.currentPercentage-t.targetPercentage),0)/2:0),K=g(()=>{const a=T.value;return a<2?"text-success":a<5?"text-warning":"text-danger"}),Q=g(()=>{const a=T.value;return a<2?"badge-success":a<5?"badge-warning":"badge-danger"}),X=g(()=>{const a=T.value;return a<2?"Balanced":a<5?"Slight Drift":"Rebalance Needed"}),Z=a=>Math.abs(a)<1?"text-success":Math.abs(a)<3?"text-warning":"text-danger",L=g(()=>D.value.filter(a=>a.selected)),E=g(()=>L.value.reduce((a,t)=>a+t.amount,0)),ee=g(()=>{const a=L.value.length;return $.value?"Executing...":a===0?"No Trades Selected":u.value==="LumpSum"?`Execute ${a} Trades Now`:u.value==="Distributed"?`Create Schedule (${y.value} periods)`:`Execute ${v.value}% Now + Schedule Rest`}),te=g(()=>{if(u.value==="LumpSum")return[];const a=E.value,t=[],s=new Date;if(u.value==="Combination"){t.push({date:s,amount:a*v.value/100,isLump:!0,period:0});const p=a*(100-v.value)/100/y.value;for(let S=0;S<y.value;S++)t.push({date:z(s,S+1),amount:p,isLump:!1,period:S+1})}else{const i=a/y.value;for(let p=0;p<y.value;p++)t.push({date:z(s,p),amount:i,isLump:!1,period:p+1})}return t});function z(a,t){const s=new Date(a);return k.value==="Weekly"?s.setDate(s.getDate()+7*t):k.value==="Fortnightly"?s.setDate(s.getDate()+14*t):s.setMonth(s.getMonth()+t),s}let H=null;const se=()=>{clearTimeout(H),H=setTimeout(()=>C(),400)},W=a=>{f.value=a,a==="none"&&(_.value=0,C())},ae=()=>{_.value=0,C()},C=async()=>{if(!x.value){M.value=!1;return}M.value=!0;try{const a=m.value!==0?`?cashFlow=${m.value}`:"",t=await F.get(`/rebalancing/${x.value}${a}`);b.value=t.data,le()}catch(a){console.error("Failed to load rebalancing report",a)}finally{M.value=!1}},V=async()=>{if(x.value)try{const a=await F.get(`/rebalancing/${x.value}/schedules`);U.value=a.data}catch(a){console.error("Failed to load schedules",a)}},le=()=>{D.value=[],b.value&&b.value.categories.forEach(a=>{if(a.recommendation==="Hold")return;const t=a.assets.sort((s,i)=>i.totalValue-s.totalValue)[0];if(t&&Math.abs(a.varianceAmount)>100){const s=Math.abs(a.varianceAmount),i=s/t.currentPrice;D.value.push({assetId:t.assetId,symbol:t.symbol,assetName:t.name,type:a.recommendation==="Buy"?"Buy":"Sell",units:i,price:t.currentPrice,amount:s,selected:!0})}})},ne=async()=>{$.value=!0;try{const a=L.value.map(t=>({assetId:t.assetId,type:t.type==="Buy"?0:1,units:t.units,amount:t.amount}));if(u.value==="LumpSum")await F.post(`/rebalancing/${x.value}/execute`,a),R.value="Trades Executed!",I.value="Your portfolio has been updated with the rebalancing transactions.";else{const t={actions:a,executionMode:u.value==="Distributed"?1:2,totalPeriods:y.value,interval:k.value==="Weekly"?0:k.value==="Fortnightly"?1:2,lumpSumPercentage:v.value,cashFlowAmount:m.value},s=await F.post(`/rebalancing/${x.value}/execute-scheduled`,t);R.value=u.value==="Combination"?`${v.value}% Executed, Rest Scheduled!`:"Schedule Created!",I.value=s.data.message,await V()}B.value=!0}catch(a){console.error("Execution failed",a),alert("Failed to execute rebalancing trades.")}finally{$.value=!1}},oe=async a=>{N.value=a;try{await F.post(`/rebalancing/schedules/${a}/execute-next`),await V(),await C()}catch(t){console.error("Tranche execution failed",t),alert(t.response?.data?.message||"Failed to execute tranche.")}finally{N.value=null}},ie=async a=>{if(confirm("Cancel this rebalancing schedule? Remaining tranches will not be executed."))try{await F.post(`/rebalancing/schedules/${a}/cancel`),await V()}catch(t){console.error("Cancel failed",t)}},ue=()=>{B.value=!1,O.push("/reports")};return de(x,()=>{C(),V()}),ce(()=>{x.value?(C(),V()):M.value=!1}),(a,t)=>(n(),o("div",ye,[t[39]||(t[39]=e("div",{class:"header-row mb-xl"},[e("div",{class:"header-content"},[e("h1",null,"Rebalancing Wizard"),e("p",{class:"subtitle"},"Align your portfolio with your target asset allocation")])],-1)),M.value?(n(),o("div",xe,[...t[10]||(t[10]=[e("div",{class:"spinner"},null,-1),e("p",null,"Analyzing portfolio allocations...",-1)])])):b.value?(n(),o(w,{key:1},[e("div",_e,[t[15]||(t[15]=ve('<div class="panel-header" data-v-4119fdef><h3 class="panel-title" data-v-4119fdef><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-4119fdef><line x1="12" y1="1" x2="12" y2="23" data-v-4119fdef></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" data-v-4119fdef></path></svg> Cash Flow Adjustment </h3></div>',1)),e("div",we,[e("button",{class:r(["mode-btn",f.value==="none"&&"active"]),onClick:t[0]||(t[0]=s=>W("none"))},[...t[11]||(t[11]=[e("span",{class:"mode-icon"},"âš–ï¸",-1),e("span",{class:"mode-label"},"Rebalance Only",-1),e("span",{class:"mode-desc"},"Realign existing holdings",-1)])],2),e("button",{class:r(["mode-btn add",f.value==="add"&&"active"]),onClick:t[1]||(t[1]=s=>W("add"))},[...t[12]||(t[12]=[e("span",{class:"mode-icon"},"ðŸ“ˆ",-1),e("span",{class:"mode-label"},"Add Funds",-1),e("span",{class:"mode-desc"},"Inject new capital",-1)])],2),e("button",{class:r(["mode-btn remove",f.value==="remove"&&"active"]),onClick:t[2]||(t[2]=s=>W("remove"))},[...t[13]||(t[13]=[e("span",{class:"mode-icon"},"ðŸ“‰",-1),e("span",{class:"mode-label"},"Remove Funds",-1),e("span",{class:"mode-desc"},"Withdraw capital",-1)])],2)]),f.value!=="none"?(n(),o("div",ke,[e("label",Ce,l(f.value==="add"?"Amount to Add":"Amount to Remove"),1),e("div",Se,[t[14]||(t[14]=e("span",{class:"currency-prefix"},"$",-1)),A(e("input",{type:"number","onUpdate:modelValue":t[3]||(t[3]=s=>_.value=s),onInput:se,min:"0",step:"1000",placeholder:"e.g. 300,000"},null,544),[[Y,_.value,void 0,{number:!0}]])]),e("button",{class:"btn btn-secondary",onClick:ae,style:{"white-space":"nowrap"}},"Clear")])):h("",!0)]),e("div",Pe,[e("div",Fe,[t[16]||(t[16]=e("span",{class:"label"},"Current Value",-1)),e("span",Me,l(c(b.value.totalValue)),1)]),m.value!==0?(n(),o("div",De)):h("",!0),m.value!==0?(n(),o("div",Le,[e("span",Ve,l(m.value>0?"Adding":"Removing"),1),e("span",{class:r(["value",m.value>0?"text-success":"text-danger"])},l(m.value>0?"+":"")+l(c(m.value)),3)])):h("",!0),t[19]||(t[19]=e("div",{class:"health-divider"},null,-1)),e("div",Ae,[e("span",$e,l(m.value!==0?"New Portfolio Value":"Total Value"),1),e("span",Ne,l(c(b.value.adjustedTotalValue)),1)]),t[20]||(t[20]=e("div",{class:"health-divider"},null,-1)),e("div",Te,[t[17]||(t[17]=e("span",{class:"label"},"Allocation Drift",-1)),e("span",{class:r(["value",K.value])},l(T.value.toFixed(1))+"%",3)]),t[21]||(t[21]=e("div",{class:"health-divider"},null,-1)),e("div",Ee,[t[18]||(t[18]=e("span",{class:"label"},"Status",-1)),e("span",{class:r(["badge",Q.value])},l(X.value),3)])]),e("div",Be,[e("table",Re,[t[22]||(t[22]=e("thead",null,[e("tr",null,[e("th",null,"Category"),e("th",{class:"text-right"},"Current"),e("th",{class:"text-right"},"Target"),e("th",{class:"text-right"},"Drift"),e("th",{class:"text-right"},"Action")])],-1)),e("tbody",null,[(n(!0),o(w,null,P(b.value.categories,s=>(n(),o("tr",{key:s.categoryId},[e("td",null,[e("div",Ie,l(s.categoryName),1),e("div",Ue,l(c(s.currentValue))+" â†’ "+l(c(s.targetValue)),1)]),e("td",je,[e("div",We,[e("div",{class:"bar-fill",style:q({width:Math.min(s.currentPercentage,100)+"%"})},null,4)]),ge(" "+l(s.currentPercentage.toFixed(1))+"% ",1)]),e("td",ze,l(s.targetPercentage.toFixed(1))+"%",1),e("td",{class:r(["text-right",Z(s.currentPercentage-s.targetPercentage)])},l((s.currentPercentage-s.targetPercentage).toFixed(1))+"% ",3),e("td",He,[e("span",{class:r(["action-tag",s.recommendation.toLowerCase()])},l(s.recommendation),3)])]))),128))])])]),e("div",Ye,[t[35]||(t[35]=e("div",{class:"section-header mb-md"},[e("h2",null,"Execution Plan"),e("p",{class:"subtitle"},"Select the trades you want to execute to realign your portfolio.")],-1)),D.value.length===0?(n(),o("div",Ge,[...t[23]||(t[23]=[e("div",{class:"icon"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),e("polyline",{points:"22 4 12 14.01 9 11.01"})])],-1),e("h3",null,"Portfolio is Balanced",-1),e("p",null,"Your current allocations are within tolerance of your targets.",-1)])])):(n(),o("div",qe,[e("div",Oe,[(n(!0),o(w,null,P(D.value,(s,i)=>(n(),o("div",{key:i,class:"action-card card"},[e("div",Je,[A(e("input",{type:"checkbox","onUpdate:modelValue":p=>s.selected=p},null,8,Ke),[[be,s.selected]])]),e("div",Qe,[e("div",{class:r(["action-type",s.type.toLowerCase()])},l(s.type),3),e("div",Xe,[e("span",Ze,l(s.symbol),1),e("span",et,l(s.assetName),1)])]),e("div",tt,[e("div",st,l(s.units.toFixed(4))+" units",1),e("div",at,"@ "+l(c(s.price)),1)]),e("div",lt,l(c(s.amount)),1)]))),128))]),e("div",nt,[t[33]||(t[33]=e("h3",{class:"panel-title"},"Execution Strategy",-1)),e("div",ot,[e("button",{class:r(["exec-mode-btn",u.value==="LumpSum"&&"active"]),onClick:t[4]||(t[4]=s=>u.value="LumpSum")},[...t[24]||(t[24]=[e("span",{class:"exec-icon"},"âš¡",-1),e("span",{class:"exec-label"},"Lump Sum",-1),e("span",{class:"exec-desc"},"Execute all at once",-1)])],2),e("button",{class:r(["exec-mode-btn",u.value==="Distributed"&&"active"]),onClick:t[5]||(t[5]=s=>u.value="Distributed")},[...t[25]||(t[25]=[e("span",{class:"exec-icon"},"ðŸ“Š",-1),e("span",{class:"exec-label"},"Distributed",-1),e("span",{class:"exec-desc"},"Spread over multiple periods",-1)])],2),e("button",{class:r(["exec-mode-btn",u.value==="Combination"&&"active"]),onClick:t[6]||(t[6]=s=>u.value="Combination")},[...t[26]||(t[26]=[e("span",{class:"exec-icon"},"ðŸ”€",-1),e("span",{class:"exec-label"},"Combination",-1),e("span",{class:"exec-desc"},"Partial now, rest scheduled",-1)])],2)]),u.value!=="LumpSum"?(n(),o("div",it,[u.value==="Combination"?(n(),o("div",ut,[t[27]||(t[27]=e("label",{class:"config-label"},"Execute Now",-1)),e("div",rt,[A(e("input",{type:"range","onUpdate:modelValue":t[7]||(t[7]=s=>v.value=s),min:"10",max:"90",step:"5",class:"slider"},null,512),[[Y,v.value,void 0,{number:!0}]]),e("span",dt,l(v.value)+"%",1)]),e("div",ct,[e("span",vt,"Now: "+l(c(E.value*v.value/100)),1),e("span",mt,"Scheduled: "+l(c(E.value*(100-v.value)/100)),1)])])):h("",!0),e("div",pt,[e("div",ht,[t[28]||(t[28]=e("label",{class:"config-label"},"Periods",-1)),A(e("select",{"onUpdate:modelValue":t[8]||(t[8]=s=>y.value=s)},[(n(),o(w,null,P(11,s=>e("option",{key:s+1,value:s+1},l(s+1)+" periods",9,gt)),64))],512),[[G,y.value,void 0,{number:!0}]])]),e("div",bt,[t[30]||(t[30]=e("label",{class:"config-label"},"Interval",-1)),A(e("select",{"onUpdate:modelValue":t[9]||(t[9]=s=>k.value=s)},[...t[29]||(t[29]=[e("option",{value:"Weekly"},"Weekly",-1),e("option",{value:"Fortnightly"},"Fortnightly",-1),e("option",{value:"Monthly"},"Monthly",-1)])],512),[[G,k.value]])])]),e("div",ft,[t[32]||(t[32]=e("h4",{class:"timeline-title"},"Planned Schedule",-1)),e("div",yt,[(n(!0),o(w,null,P(te.value,(s,i)=>(n(),o("div",{key:i,class:r(["timeline-item",s.isLump&&"is-lump"])},[t[31]||(t[31]=e("div",{class:"timeline-dot"},null,-1)),e("div",xt,[e("span",_t,l(j(s.date)),1),e("span",wt,l(c(s.amount)),1),s.isLump?(n(),o("span",kt,"Lump Sum")):(n(),o("span",Ct,"Period "+l(s.period),1))])],2))),128))])])])):h("",!0)]),e("div",St,[L.value.length>0?(n(),o("div",Pt,[t[34]||(t[34]=e("span",{class:"exec-total-label"},"Total Selected",-1)),e("span",Ft,l(c(E.value)),1)])):h("",!0),e("button",{class:"btn btn-primary btn-lg",onClick:ne,disabled:L.value.length===0||$.value},l(ee.value),9,Mt)])]))]),U.value.length>0?(n(),o("div",Dt,[t[36]||(t[36]=e("div",{class:"section-header mb-md"},[e("h2",null,"Active Schedules"),e("p",{class:"subtitle"},"Manage your ongoing rebalancing schedules.")],-1)),(n(!0),o(w,null,P(U.value,s=>(n(),o("div",{key:s.id,class:"schedule-card card mb-md"},[e("div",Lt,[e("div",null,[e("span",Vt,l(s.executionMode),1),e("span",At,"Created "+l(j(s.createdDate)),1)]),e("div",$t,[e("span",null,l(s.completedPeriods)+"/"+l(s.totalPeriods)+" completed",1),e("div",Nt,[e("div",{class:"progress-fill",style:q({width:s.completedPeriods/s.totalPeriods*100+"%"})},null,4)])])]),e("div",Tt,[(n(!0),o(w,null,P(s.items,i=>(n(),o("div",{key:i.id,class:r(["schedule-item",i.status.toLowerCase()])},[e("span",Et,l(i.periodNumber===0&&s.executionMode==="Combination"?"Lump":`P${i.periodNumber+1}`),1),e("span",Bt,l(j(i.plannedDate)),1),e("span",Rt,l(c(i.actions.reduce((p,S)=>p+S.amount,0))),1),e("span",{class:r(["item-status",i.status.toLowerCase()])},l(i.status),3)],2))),128))]),e("div",It,[s.items.some(i=>i.status==="Pending")?(n(),o("button",{key:0,class:"btn btn-primary",onClick:i=>oe(s.id),disabled:N.value===s.id},l(N.value===s.id?"Executing...":"Execute Next Tranche"),9,Ut)):h("",!0),s.items.some(i=>i.status==="Pending")?(n(),o("button",{key:1,class:"btn btn-secondary btn-danger-outline",onClick:i=>ie(s.id)}," Cancel Schedule ",8,jt)):h("",!0)])]))),128))])):h("",!0)],64)):(n(),o("div",Wt,[...t[37]||(t[37]=[e("p",null,"No rebalancing data available. Ensure your portfolio has target allocations set up.",-1)])])),(n(),me(pe,{to:"body"},[B.value?(n(),o("div",zt,[e("div",Ht,[t[38]||(t[38]=e("div",{class:"success-icon"},[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},[e("path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14"}),e("polyline",{points:"22 4 12 14.01 9 11.01"})])],-1)),e("h2",null,l(R.value),1),e("p",null,l(I.value),1),e("div",{class:"modal-actions"},[e("button",{class:"btn btn-primary",onClick:ue},"Great, take me to Ledger")])])])):h("",!0)]))]))}},Jt=re(Yt,[["__scopeId","data-v-4119fdef"]]);export{Jt as default};
